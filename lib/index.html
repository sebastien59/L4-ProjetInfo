<html>
  <head>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript">
      (function($){
        var chatbox = document.createElement('div');
        var messagebox = document.createElement('div');
        var messageForm = document.createElement('div');
        var inputMessage = document.createElement('input');
        var buttonSend = document.createElement('button');

        var chatExist = false;

        var addMessage= function(message, isConseiller){
          isConseiller = (typeof isConseiller !== 'undefined') ?  isConseiller : 0;

          var div_message = document.createElement('div');
          var div_clear = document.createElement('div');

          $(div_clear).addClass('clearfix');

          if(isConseiller == 0)
            $(div_message).addClass('message-right');

          $(div_message).addClass('message');
          $(div_message).html(message);

          $(messagebox).append($(div_message))
          $(messagebox).append($(div_clear))
        }

        var sendMessage= function(message){
            // TODO : Gérer les sockets pour l'envoie du message.

            addMessage(message);
        }

        $.fn.createChat = function (name){
          $(chatbox).addClass("chatbox");
          $(chatbox).append('<h3>'+name+'</h3>');

          $(messagebox).addClass('messagebox');
          $(chatbox).append(messagebox);

          $(messageForm).addClass('messageForm');
          $(inputMessage).attr('type', 'text');
          $(inputMessage).addClass('inputMessage');
          $(buttonSend).addClass('buttonSend');
          $(buttonSend).html('Envoyer');

          $(messageForm).append(inputMessage);
          $(messageForm).append(buttonSend);

          $(chatbox).append(messageForm);
          $('body').append(chatbox);

          $(buttonSend).click(function(){
            sendMessage($(inputMessage).val());
            $(inputMessage).val('');
          });

          addMessage("Salut");
          addMessage("test",1);

          return {
                    chatbox: $(chatbox),
                    messagebox: $(messagebox),
                    input: $(inputMessage),
                    button: $(buttonSend)
                  }
        };

        $.fn.deleteChat = function(){
          $(chatbox).remove();
          chatExist = 0;
          chatbox = document.createElement('div');
          messagebox = document.createElement('div');
          messageForm = document.createElement('div');
          inputMessage = document.createElement('input');
          buttonSend = document.createElement('button');
        }

        $.fn.createButton= function(options){
          var settings = $.extend({
            text:"button",
          }, options);

          this.html(settings.text);

          
        };

        $.fn.createGroupList = function(){
          var select = document.createElement('select');

          // TODO: Requête Ajax qui récupère, en json, les groupes.
          // json de "simulation"

          var groups=[
            {id: 1, name: "Retourner un commande"},
            {id: 2, name: "Demande technique"},
            {id: 3, name: "Conseiller en informatique"},
            {id: 4, name: "Commander chinois"},
          ];

          $(groups).each(function(index, group){
            var opt = document.createElement("option");
            $(opt).html(group.name);
            $(opt).val(group.id);
            select.append(opt);
          })

          $(select).change(function(){
            var selected;
            $(groups).each(function(index, group){
              if(group.id == $(select).val()){
                selected=group;
              }
            });

            if(chatExist==0){
              // On gère le socket afin de creer le chat coté serveur également.

              $(jQuery).createChat(selected.name);
              chatExist=1;
            }else{
              if(confirm("Vous avez déjà un chat en cours, souhaitez vous le quitter ?")){
                $(jQuery).deleteChat();
                $(jQuery).createChat(selected.name);
                chatExist=1;
              }
            }
          });

          this.append(select);
        }
      }(jQuery));


      $(document).ready(function(){
        //var mychat = $(jQuery).createChat("Mon Chat");
        var mybutton = $('.SavButton').createButton({
          text: 'MON BOUTON'
        });

        var list = $(".groupList").createGroupList();
      });
    </script>

    <style>
      .clearfix{
        clear:both;
      }

      .chatbox{
        position: fixed;
        width:300px;
        height: 400px;
        background: #ECEFF1;
        border-radius: 7px 7px 0px 0px;
        box-shadow: 0px 0px 10px #b3b3b3;
        bottom:0;
        right:30;
      }

      .chatbox h3{
        margin:5px;
        display: block;
        text-align: center;
        font-family: Arial;
        border-bottom: 1px solid #D1D1D1;
      }

      .chatbox .messagebox{
        height: 330px;
        overflow:scroll;
      }

      .chatbox .messagebox .message{
        min-height: 20px;
        width:240px;
        margin-top:5px;
        margin-left:10px;
        margin-right:10px;
        border-radius:3px;
        padding:3px;
        padding-left: 7px;
        color: white;

        font-family:Arial;
        background:#4688d6;
      }

      .chatbox .messagebox .message.message-right{
        float:right;
        background:#E5E5E5;
        color:#3F3F3F;
      }

      .messageForm .inputMessage{
        margin-left: 5px;
        width:230px;
        height: 27px;
        font-size:15px;
        border-radius:3px 0px 0px 3px;
        border:0;
        margin-top:2px;
        box-shadow: 0px 0px 5px #C5C5C5;
      }

      .messageForm .buttonSend{
        padding-top:7px;
        padding-bottom:6px;
        border-radius: 0px 3px 3px 0px;
        border:0;
        width:60px;

        font-family: Arial;
        font-size: 13px;
        color:white;

        background:#4688d6;
        box-shadow: 0px 0px 5px #C5C5C5;
      }
    </style>
  </head>
  <body>
    <button class="SavButton"></button>

    <div class="panelSav">
      <div class="groupList"></div>
    </div>
  </body>
</html>
