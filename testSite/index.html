<html>
  <head>
    <meta charset="utf-8">
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
    <script type="text/javascript">
      (function($){
        var site_url = 'http://localhost:8080'
        var socket=io.connect(site_url);
        var chatbox = document.createElement('div');
        var messagebox = document.createElement('div');
        var messageForm = document.createElement('div');
        var inputMessage = document.createElement('input');
        var buttonSend = document.createElement('button');

        var chatExist = false;

        var projectConfig = {
          entreprise:1
        };

        var addMessage= function(message, isConseiller){
          isConseiller = (typeof isConseiller !== 'undefined') ?  isConseiller : 0;

          var div_message = document.createElement('div');
          var div_clear = document.createElement('div');

          $(div_clear).addClass('clearfix');

          if(isConseiller == 0)
            $(div_message).addClass('message-right');

          $(div_message).addClass('message');
          $(div_message).html(message);

          $(messagebox).append($(div_message))
          $(messagebox).append($(div_clear))
        }

        var sendMessage= function(message){
            // TODO : Gérer les sockets pour l'envoie du message.
            console.log(projectConfig.chat);
            socket.emit('message', {chatId: projectConfig.chat.id,message: message, emailClient: $('#emailClient').val()});
            addMessage(message);
        }

        $.fn.createChat = function (name){
          $(chatbox).addClass("chatbox");
          $(chatbox).append('<h3>'+name+'</h3>');

          $(messagebox).addClass('messagebox');
          $(chatbox).append(messagebox);

          $(messageForm).addClass('messageForm');
          $(inputMessage).attr('type', 'text');
          $(inputMessage).addClass('inputMessage');
          $(buttonSend).addClass('buttonSend');
          $(buttonSend).html('Envoyer');

          $(messageForm).append(inputMessage);
          $(messageForm).append(buttonSend);

          $(chatbox).append(messageForm);
          $('body').append(chatbox);

          $(buttonSend).click(function(){
            sendMessage($(inputMessage).val());
            $(inputMessage).val('');
          });


          return {
                    chatbox: $(chatbox),
                    messagebox: $(messagebox),
                    input: $(inputMessage),
                    button: $(buttonSend)
                  }
        };

        $.fn.deleteChat = function(){
          $(chatbox).remove();
          chatExist = 0;
          chatbox = document.createElement('div');
          messagebox = document.createElement('div');
          messageForm = document.createElement('div');
          inputMessage = document.createElement('input');
          buttonSend = document.createElement('button');
        }

        $.fn.createButton= function(options){
          var settings = $.extend({
            text:"button",
          }, options);

          this.html(settings.text);
        };

        $.fn.createGroupList = function(){
          var select = document.createElement('select');

          // TODO: Requête Ajax qui récupère, en json, les groupes.
          // json de "simulation"

          var groups=[
            {id:0, name:'Sélectionner un groupe'},
            {id: 1, name: "Retourner un commande"},
            {id: 2, name: "Demande technique"},
            {id: 3, name: "Conseiller en informatique"},
            {id: 4, name: "Commander chinois"},
          ];

          $(groups).each(function(index, group){
            var opt = document.createElement("option");
            $(opt).html(group.name);
            $(opt).val(group.id);
            select.append(opt);
          })

          $(select).change(function(){
            var selected;
            $(groups).each(function(index, group){
              if(group.id == $(select).val()){
                selected=group;
              }
            });

            if(chatExist==0){
              // On gère le socket afin de creer le chat coté serveur également.

              socket.emit('userConnexion', {entrepriseId: projectConfig.entreprise, groupe: selected, emailClient: $('#emailClient').val()});

              socket.on('initConnexion', function(data){
                console.log(data);
              });

              socket.on('chatinfo', function(data){
                projectConfig.chat=data;
                console.log(projectConfig);
              });
              socket.on('message', function(data){
                addMessage(data.message, 1);
              });

              $(jQuery).createChat(selected.name);
              chatExist=1;
            }else{
              if(confirm("Vous avez déjà un chat en cours, souhaitez vous le quitter ?")){
                $(jQuery).deleteChat();
                $(jQuery).createChat(selected.name);
                chatExist=1;
              }
            }
          });

          this.append(select);
        }

        socket.on('call', function(data){
          console.log(data);
          data.call
        });

        // State
        var me = {};
        var myStream;
        var peers = {};
        var call = {};

        $.fn.initVoice = function(initData){
          var initData = (typeof(initData) === undefined)?null:initData;
          if(initData === null){
            $.get(site_url+'/peer/new', function(data){
              console.log(data);
              console.log("test");
              // Handle prefixed versions
              navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

              call = data.call;

              init();
            });
          }else{
            console.log(initData);
            call=initData.call;
            init();
          }
        }


        // Start everything up
        function init() {
          if (!navigator.getUserMedia) return unsupported();

          getLocalAudioStream(function(err, stream) {
            if (err || !stream) return;

            connectToPeerJS(function(err) {
              if (err) return;

              registerIdWithServer(me.id);
              if (call.peers.length) callPeers();
              else displayShareMessage();
            });
          });
        }

        // Connect to PeerJS and get an ID
        function connectToPeerJS(cb) {
          display('Connecting to PeerJS...');
          me = new Peer({key: 'dewpt2r4rpddvx6r'});

          me.on('call', handleIncomingCall);

          me.on('open', function() {
            display('Connected.');
            display('ID: ' + me.id);
            cb && cb(null, me);
          });

          me.on('error', function(err) {
            display(err);
            cb && cb(err);
          });
        }

        // Add our ID to the list of PeerJS IDs for this call
        function registerIdWithServer() {
          display('Registering ID with server...');
          var id = me.id;
          console.log(call);
          $.post(site_url+'/peer/' + call.id + '/addpeer/' + id);
        }

        // Remove our ID from the call's list of IDs
        function unregisterIdWithServer() {
          $.post(site_url+'/peer/' + call.id + '/removepeer/' + me.id);
        }

        // Call each of the peer IDs using PeerJS
        function callPeers() {
          call.peers.forEach(callPeer);
        }

        function callPeer(peerId) {
          display('Calling ' + peerId + '...');
          var peer = getPeer(peerId);
          peer.outgoing = me.call(peerId, myStream);

          peer.outgoing.on('error', function(err) {
            display(err);
          });

          peer.outgoing.on('stream', function(stream) {
            display('Connected to ' + peerId + '.');
            addIncomingStream(peer, stream);
          });
        }

        // When someone initiates a call via PeerJS
        function handleIncomingCall(incoming) {
          display('Answering incoming call from ' + incoming.peer);
          var peer = getPeer(incoming.peer);
          peer.incoming = incoming;
          incoming.answer(myStream);
          peer.incoming.on('stream', function(stream) {
            addIncomingStream(peer, stream);
          });
        }

        // Add the new audio stream. Either from an incoming call, or
        // from the response to one of our outgoing calls
        function addIncomingStream(peer, stream) {
          display('Adding incoming stream from ' + peer.id);
          peer.incomingStream = stream;
          playStream(stream);
        }

        // Create an <audio> element to play the audio stream
        function playStream(stream) {
          var audio = $('<audio autoplay />').appendTo('body');
          audio[0].src = (URL || webkitURL || mozURL).createObjectURL(stream);
        }

        // Get access to the microphone
        function getLocalAudioStream(cb) {
          display('Trying to access your microphone. Please click "Allow".');

          navigator.getUserMedia (
            {video: false, audio: true},

            function success(audioStream) {
              display('Microphone is open.');
              myStream = audioStream;
              if (cb) cb(null, myStream);
            },

            function error(err) {
              display('Couldn\'t connect to microphone. Reload the page to try again.');
              if (cb) cb(err);
            }
          );
        }


        ////////////////////////////////////
        // Helper functions
        function getPeer(peerId) {
          return peers[peerId] || (peers[peerId] = {id: peerId});
        }

        function displayShareMessage() {
          display('Give someone this URL to chat.');
          //display('<input type="text" value="' + location.href + '" readonly>');

          /*$('#display input').click(function() {
            this.select();
          });*/


        }

        function unsupported() {
          display("Your browser doesn't support getUserMedia.");
        }

        function display(message) {
          console.log(message);
        }
      }(jQuery));


      $(document).ready(function(){
        //var mychat = $(jQuery).createChat("Mon Chat");
        var mybutton = $('.SavButton').createButton({
          text: 'MON BOUTON'
        });

        var list = $(".groupList").createGroupList();
      });
    </script>

    <style>
      .clearfix{
        clear:both;
      }

      .chatbox{
        position: fixed;
        width:300px;
        height: 400px;
        background: #ECEFF1;
        border-radius: 7px 7px 0px 0px;
        box-shadow: 0px 0px 10px #b3b3b3;
        bottom:0;
        right:30;
      }

      .chatbox h3{
        margin:5px;
        display: block;
        text-align: center;
        font-family: Arial;
        border-bottom: 1px solid #D1D1D1;
      }

      .chatbox .messagebox{
        height: 330px;
        overflow:scroll;
      }

      .chatbox .messagebox .message{
        min-height: 20px;
        width:240px;
        margin-top:5px;
        margin-left:10px;
        margin-right:10px;
        border-radius:3px;
        padding:3px;
        padding-left: 7px;
        color: white;

        font-family:Arial;
        background:#4688d6;
      }

      .chatbox .messagebox .message.message-right{
        float:right;
        background:#E5E5E5;
        color:#3F3F3F;
      }

      .messageForm .inputMessage{
        margin-left: 5px;
        width:230px;
        height: 27px;
        font-size:15px;
        border-radius:3px 0px 0px 3px;
        border:0;
        margin-top:2px;
        box-shadow: 0px 0px 5px #C5C5C5;
      }

      .messageForm .buttonSend{
        padding-top:7px;
        padding-bottom:6px;
        border-radius: 0px 3px 3px 0px;
        border:0;
        width:60px;

        font-family: Arial;
        font-size: 13px;
        color:white;

        background:#4688d6;
        box-shadow: 0px 0px 5px #C5C5C5;
      }
    </style>
  </head>
  <body>
    <input type="text" id="emailClient" value="mail@test.com"/>
    <button class="SavButton"></button>


    <button onclick='$(document).initVoice()'>voice chat</button>
    <div class="panelSav">
      <div class="groupList"></div>
    </div>
  </body>
</html>
